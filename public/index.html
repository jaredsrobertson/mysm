<script src="config.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging.js";

        // Check if config loaded
        if (!self.MYSM_CONFIG) {
            alert("Error: config.js is missing! Create it from config.example.js");
        }

        // LOAD CONFIG FROM THE EXTERNAL FILE
        const firebaseConfig = self.MYSM_CONFIG.firebase;
        const VAPID_KEY = self.MYSM_CONFIG.vapidKey;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const messaging = getMessaging(app);

        // --- GLOBAL VARIABLES ---
        let deferredPrompt; 
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        const isIos = /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());

        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/firebase-messaging-sw.js')
                .then((registration) => {
                    console.log('Service Worker Registered');
                });
        }

        // --- 1. FLOW CONTROLLER ---
        function checkState() {
            const isStandardStandalone = window.matchMedia('(display-mode: standalone)').matches;
            const isIosStandalone = ('standalone' in window.navigator) && (window.navigator.standalone);
            const isApp = isStandardStandalone || isIosStandalone;

            if (isMobile && !isApp) {
                document.getElementById('install-screen').classList.remove('hidden');
                if(isIos) document.getElementById('ios-install-area').classList.remove('hidden');
                else document.getElementById('android-install-area').classList.remove('hidden');
            } 
            else if (!localStorage.getItem('mysm_name')) {
                document.getElementById('setup-screen').classList.remove('hidden');
            } 
            else {
                showMainApp();
            }
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });

        window.triggerAndroidInstall = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') console.log('User accepted');
                deferredPrompt = null;
            } else {
                alert("To install, tap the Chrome menu (3 dots) and select 'Install App'");
            }
        };

        window.saveUser = async () => {
            const name = document.getElementById('my-name').value.trim();
            const code = document.getElementById('partner-code').value.trim();
            if(!name || !code) return alert("Please fill in both!");

            localStorage.setItem('mysm_name', name);
            localStorage.setItem('mysm_code', code);

            document.getElementById('setup-screen').classList.add('hidden');
            checkState();

            setDoc(doc(db, "users", name + "_" + code), {
                name: name, code: code, last_seen: serverTimestamp()
            }, { merge: true }).catch((error) => console.error("Sync error:", error));
        };

        async function showMainApp() {
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('welcome-msg').innerText = `Hi, ${localStorage.getItem('mysm_name')}!`;
            
            if (Notification.permission === "granted") {
                document.getElementById('notify-btn').style.display = 'none';
                document.getElementById('status-msg').style.display = 'block';
                
                try {
                    const registration = await navigator.serviceWorker.ready;
                    const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: registration });
                    
                    const name = localStorage.getItem('mysm_name');
                    const code = localStorage.getItem('mysm_code');
                    await setDoc(doc(db, "users", name + "_" + code), { fcmToken: token }, { merge: true });
                } catch(e) {
                    console.error("Silent token refresh failed:", e);
                }
            }
        }

        window.requestPermission = async () => {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showMainApp(); 
                } else {
                    alert("Notifications denied. Please enable them in settings.");
                }
            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
            }
        }

        window.sendLove = async (msg) => {
           try {
               const btn = event.target; 
               const originalText = btn.innerText;
               btn.innerText = "Sent! ðŸ’Œ";
               setTimeout(() => btn.innerText = originalText, 2000);

               const name = localStorage.getItem('mysm_name');
               const code = localStorage.getItem('mysm_code');
               
               await setDoc(doc(db, "history", code), {
                   last_message: msg, from: name, timestamp: serverTimestamp(), trigger_id: Date.now()
               }, { merge: true });
           } catch (error) { alert("Error: " + error.message); }
        }

        window.resetApp = () => {
            if(confirm("Sign out?")) {
                localStorage.clear();
                window.location.reload();
            }
        };

        checkState();
    </script>